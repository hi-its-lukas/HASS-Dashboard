Die zuletzt durchgef√ºhrten √Ñnderungen wurden √ºberpr√ºft durch einen Cyber-Security-Analysten mit tiefen Programmierkenntnissen.
Dabei wurden mehrere kritische Sicherheits-, Architektur- und Logikfehler festgestellt, die den zuvor klar definierten Vorgaben widersprechen.

Ihr m√ºsst den gesamten Code erneut penibel √ºberpr√ºfen, alle unten genannten Punkte beheben und verifizieren, dass keine weiteren Verst√∂√üe existieren.

Dies ist keine optionale Verbesserung, sondern eine verpflichtende Sicherheitskorrektur.

‚ùå KRITISCHE FESTSTELLUNGEN (M√úSSEN BEHOBEN WERDEN)
1Ô∏è‚É£ HA-TOKEN WIRD WEITERHIN AN DEN CLIENT AUSGELIEFERT (KRITISCH)
Feststellung

Es existiert ein API-Endpoint, der den globalen Home-Assistant Admin Token als JSON an den Browser zur√ºckgibt:

/app/api/ha/ws-auth/route.ts

Response enth√§lt { wsUrl, token }

‚û°Ô∏è Das ist ein direkter Sicherheitsbruch.
Der Token darf unter keinen Umst√§nden:

im Browser erscheinen

per API ausgeliefert werden

in WebSocket-Handshake-Daten enthalten sein

in Logs, DevTools oder JS-State auftauchen

Verpflichtende Korrektur

‚ùå Endpoint /api/ha/ws-auth vollst√§ndig entfernen oder so umbauen, dass kein Token zur√ºckgegeben wird

‚úÖ Client darf nur zu eurem eigenen WebSocket-Proxy verbinden

‚úÖ NUR der Server darf den HA-Token kennen

2Ô∏è‚É£ OAUTH IST NICHT VOLLST√ÑNDIG ENTFERNT (KRITISCH)
Feststellung

Trotz klarer Anweisung ist OAuth weiterhin:

im Code vorhanden

teilweise noch aktiv erreichbar

in Login-Flows verdrahtet

in Doku beschrieben

Gefundene Probleme:

OAuth-Branch in /api/auth/login

OAuth-Callback-Route existiert noch

lib/auth/ha-oauth.ts existiert vollst√§ndig

Deployment- & Replit-Doku beschreiben weiterhin OAuth/PKCE

‚û°Ô∏è OAuth MUSS vollst√§ndig entfernt werden ‚Äì nicht ‚Äûdeaktiviert‚Äú, sondern gel√∂scht.

Verpflichtende Korrektur

‚ùå Entfernt alle OAuth-Routen (/api/auth/callback, OAuth-Branches)

‚ùå Entfernt alle OAuth-Libraries, Helper, Token-Handler

‚ùå Entfernt OAuth-Modelle / DB-Logik, sofern nicht mehr gebraucht

‚ùå Entfernt jede OAuth-Referenz aus:

Code

UI

Doku

README / DEPLOYMENT.md / replit.md

Abnahmekriterium
grep -R "oauth" .


‚û°Ô∏è darf keine produktiven Codepfade mehr finden.

3Ô∏è‚É£ WEBSOCKET-ARCHITEKTUR ENTSPRICHT NICHT DER SICHERHEITSVORGABE
Feststellung

Aktuell:

Token wird clientseitig f√ºr WebSocket genutzt

Kein echter serverseitiger WS-Proxy

Sicherheitsziel ‚ÄûToken bleibt serverseitig‚Äú wird verletzt

Verpflichtende Zielarchitektur (NICHT verhandelbar)
‚úÖ Prim√§r: Serverseitiger WebSocket-Proxy (MUSS)

Browser ‚Üí euer WS-Endpoint (kein Token)

Server ‚Üí HA WebSocket (mit globalem Token)

Proxy forwardet Messages bidirektional

WS-Connect nur mit g√ºltiger interner Session

üü° Sekund√§r: Polling NUR ALS FALLBACK

Polling nur, wenn WS-Proxy nicht erreichbar

Polling:

serverseitig

gecached / fan-out

rate-limited (‚â•10‚Äì30s)

Client darf niemals direkt gegen HA pollen

4Ô∏è‚É£ DEFAULT-ADMIN (admin/admin) IST AKTIV (HOCHRISIKO)
Feststellung

Default-Admin wird automatisch angelegt

Login-UI zeigt ‚Äûadmin / admin‚Äú

‚û°Ô∏è In Production ein massives Sicherheitsrisiko.

Verpflichtende Korrektur

Default-Admin nur:

in Dev ODER

wenn ALLOW_DEFAULT_ADMIN=true

In Production:

Setup-Wizard ODER

Initial-Admin muss manuell erstellt werden

‚ùå Login-UI darf keine Default-Credentials anzeigen

5Ô∏è‚É£ CSRF / ORIGIN-HARDENING FEHLT BEI KRITISCHEN ROUTEN
Feststellung

Session Cookies sind sameSite=lax

Keine zus√§tzliche Origin/Referer-Validierung

Verpflichtende Korrektur

F√ºr alle state-ver√§ndernden Endpoints (Settings, Secrets, Admin):

Origin / Referer strikt gegen APP_BASE_URL pr√ºfen

Alternativ zus√§tzlich CSRF-Token (Double Submit)

6Ô∏è‚É£ DOKUMENTATION IST SICHERHEITSWIDRIG & INKONSISTENT
Feststellung

Doku beschreibt OAuth, PKCE, Redirects

Doku widerspricht neuer Architektur

F√ºhrt zu Fehlkonfigurationen

Verpflichtende Korrektur

Doku vollst√§ndig aktualisieren:

‚ùå OAuth raus

‚úÖ Globaler Admin Token in Settings

‚úÖ Token verschl√ºsselt in DB

‚úÖ WS-Proxy + Polling-Fallback

DEPLOYMENT.md & replit.md angleichen

üîç ERNEUTE PENIBLE GESAMTPR√úFUNG (PFLICHT)

Nach Umsetzung m√ºsst ihr selbst erneut pr√ºfen:

Sicherheits-Checks

Token erscheint nirgendwo im Browser (Network / WS / Storage)

Kein Endpoint liefert Secrets zur√ºck

Kein OAuth-Codepfad erreichbar

WS-Connect ohne Session ‚Üí abgelehnt

Code-Checks

Alle HA API-Routen nutzen ausschlie√ülich den globalen Token serverseitig

Kein alter OAuthToken / User-Token Zugriff

Kein toter, aber erreichbarer Legacy-Code

üì¶ DELIVERABLES (ZWINGEND)

Code-Fixes

Alle oben genannten Punkte umgesetzt

Kurzer Security-Report

Welche kritischen Punkte wurden behoben

Wie wurde Token-Leak verhindert

Testliste

WS funktioniert ohne Token im Client

Polling greift nur bei Proxy-Fehler

Admin-Setup sicher

‚ùó WICHTIGER HINWEIS

Diese Nachbesserung ist keine optionale Optimierung, sondern eine notwendige Sicherheitskorrektur, um:

Token-Leak

Account-√úbernahme

vollst√§ndige HA-Kompromittierung

zu verhindern.