You are a senior Next.js 14 (App Router) + TypeScript engineer.

We have a working dashboard (Next.js 14, TS strict, Tailwind, Docker Compose)
running on a Raspberry Pi. Now we need a major upgrade:

GOALS
A) Replace .env-based HA config with a per-user Settings system stored server-side.
B) Implement "Login with Home Assistant" OAuth so users authenticate via HA.
C) Store HA tokens securely server-side (never expose to browser).
D) Provide Settings UI to configure:
   - HA connection status (connected / error / last check)
   - Entity discovery & mapping (persons/lights/covers/rooms etc.)
   - Custom buttons (Alexa announcements, routines) configurable via HA services
E) Add collapsible sidebar on desktop (like Home Assistant).
F) Support internal + external access with HTTPS. Provide an optional approach to manage Let's Encrypt via settings (or document why it must be done outside the app).

SECURITY REQUIREMENTS (MUST FOLLOW)
- NEVER put HA tokens in NEXT_PUBLIC_ variables.
- Browser must never receive HA long-lived tokens directly.
- Use secure httpOnly cookies for sessions.
- Add CSRF protection (or same-site + double-submit pattern).
- Ensure Settings routes are authenticated.
- Provide a safe default for external access (HTTPS and auth required).

ARCHITECTURE REQUIREMENTS
1) Introduce a server-side persistence layer (SQLite recommended).
   - Store users and per-user settings/config.
   - Store HA OAuth tokens per user (encrypted at rest).
2) Use Next.js Route Handlers (/app/api/...) for backend endpoints.
3) Build an HA API proxy layer:
   - Server communicates to HA via REST/WebSocket using stored tokens.
   - Client calls our server endpoints only.
4) Keep Docker Compose-based deployment and make sure `docker compose up -d --build` works.

IMPLEMENTATION PLAN (DO THESE IN ORDER)
1) Persistence
   - Add SQLite (e.g. better-sqlite3 or sqlite + prisma; choose simplest reliable).
   - Create tables:
     users: id, created_at, ha_user_id, ha_name, ha_instance_url, etc.
     oauth_tokens: user_id, access_token_enc, refresh_token_enc, expires_at
     dashboard_config: user_id, json_config (or normalized tables)
     optionally: audit/log table
   - Add encryption for tokens at rest using a server-only secret (ENV OK on server).
     Example: ENCRYPTION_KEY (32 bytes) used with AES-GCM.
2) Auth with Home Assistant (OAuth)
   - Implement "Login with Home Assistant" button.
   - Implement OAuth flow:
     /login -> redirect user to HA authorize endpoint
     /api/auth/callback -> exchange code for token
   - After token obtained, fetch current HA user identity and store mapping.
   - Create a session for our app (httpOnly cookie).
3) Settings UI
   - Add /settings page (protected):
     - Show connection status
     - Button to "Re-check connection"
     - Entity Discovery:
       - Fetch states + registries (areas/entities/devices) from HA via our server
       - Propose automatic grouping:
         persons: domain person.*
         lights: domain light.*
         covers: cover.*
         rooms from area registry
     - Allow user to edit selections per dashboard section:
       - which people show in "Family"
       - which lights grouped by room
       - which covers grouped by room
       - which scripts/scenes show as "Alexa announcements / routines" buttons
       - buttons should be configurable by: label, icon, service (domain/service), target (entity_id/area_id), payload JSON
     - Save config per user.
4) Dashboard rendering from config
   - Remove hardcoded entities from pages and instead load per-user config.
   - On each page, call /api/config + /api/ha/... endpoints.
   - Ensure SSR/client boundary correctness ("use client" where needed).
5) Collapsible sidebar (desktop)
   - Add a collapse toggle.
   - Collapsed mode shows icons only; expanded shows icons + labels.
   - Persist UI preference in localStorage (per browser) or in per-user config.
6) HTTPS / Let's Encrypt
   - Provide a recommended approach:
     - Prefer external reverse proxy (Caddy/Nginx) or Cloudflare Tunnel.
   - If "Let's Encrypt via Settings" is requested:
     - Implement as documentation + config generator rather than attempting to run privileged cert issuance inside the Next.js container.
     - Optionally provide a separate companion container/service for Caddy in docker-compose:
       - Caddy handles HTTPS + automatic Let's Encrypt.
       - Next.js app runs behind it on internal network.
     - Add Settings fields that generate the Caddyfile (domain, email) and show instructions.
     - Do NOT try to obtain certs from within the Next.js runtime directly.

DELIVERABLES
- Code changes applied across repo.
- A migration/seed script for SQLite.
- Clear API endpoints:
  - GET /api/me (session user)
  - POST /api/logout
  - GET /api/settings (get config)
  - POST /api/settings (save config)
  - GET /api/status (HA connectivity check)
  - GET /api/ha/states (proxy states)
  - POST /api/ha/call-service (execute service)
  - GET /api/ha/registries (areas/entities/devices if available)
- Updated docker-compose.yml:
  - add volume for db (/data)
  - optionally add caddy service for HTTPS
- Ensure build stability:
  - `npm run build` passes
  - `docker compose up -d --build` passes

OUTPUT FORMAT
- Provide a concise summary of changes.
- List each new/modified file with key code snippets.
- Include step-by-step deployment instructions for Raspberry Pi:
  - env vars to set (server-only)
  - how to bring up with docker compose
  - how to configure HA OAuth redirect URLs
  - how to enable HTTPS (Caddy/Cloudflare)
- Do not introduce unnecessary refactors not required for these goals.
