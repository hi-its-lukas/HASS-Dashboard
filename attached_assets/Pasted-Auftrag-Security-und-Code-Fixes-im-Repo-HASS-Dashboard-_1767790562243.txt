Auftrag: Security- und Code-Fixes im Repo „HASS-Dashboard“
Ziel

Behebe die folgenden Sicherheits- und Architekturprobleme vollständig, inkl. Code-Änderungen, DB-Migration (falls nötig) und kurzen Tests/Checks.

1) UniFi-Credentials: NICHT im Klartext speichern, NICHT an den Client ausliefern (KRITISCH)
Problem

Aktuell werden UniFi username/password im layoutConfig gespeichert und über /api/settings an den Browser zurückgegeben.

Umsetzung (Pflicht)

UniFi-Credentials aus layoutConfig entfernen

layoutConfig.unifi.password darf nie persistiert werden.

layoutConfig.unifi.username nur speichern, wenn wirklich benötigt; sonst ebenfalls auslagern.

Neues Prisma-Model für UniFi Credentials

Erstelle z.B. UnifiCredential (oder erweitere OAuthToken-Pattern), mindestens:

id

controllerUrl

username (optional)

passwordEnc (verschlüsselt)

passwordIv/nonce

passwordTag (falls getrennt gespeichert)

updatedAt

DB-Migration erstellen und anwenden.

Password-Verschlüsselung

Nutze die vorhandene AES-256-GCM Verschlüsselungslogik (wie bei encryptToken/decryptToken).

Implementiere encryptSecret() / decryptSecret() (nicht Tokens, sondern generisch).

Speichere nur Ciphertext + Nonce + Tag.

API-Verhalten ändern

GET /api/settings darf niemals ein Passwort zurückliefern.
Stattdessen: unifi: { controllerUrl, username, hasPassword: true/false }

POST /api/settings:

Wenn ein password im Request kommt → verschlüsseln und in UnifiCredential speichern.

Danach niemals Passwort in layoutConfig schreiben.

Im Frontend: Passwortfeld immer leer anzeigen; optional „Passwort gesetzt“ via hasPassword.

Backwards-Compatibility / Cleanup

Falls bereits Passwörter in der DB im layoutConfig liegen:

Migration-Skript oder Runtime-Upgrade: beim nächsten Save auslesen → verschlüsselt in neues Model schreiben → aus layoutConfig löschen.

Akzeptanzkriterien

In DB existiert kein Klartext-Passwort mehr in layoutConfig.

/api/settings Response enthält kein Passwort, auch nicht im JSON.

UniFi Login funktioniert weiterhin.

2) Home Assistant User-Info: Keine „Token-Substring“-UserIDs (KRITISCH)
Problem

fetchHAUserInfo() erzeugt User-ID aus accessToken.slice(0,32) → unsicher, keine echte Identität.

Umsetzung (Pflicht)

Implementiere eine echte User-Identifizierung:

Nutze einen passenden Home Assistant Endpoint zur Verifikation (z.B. ein „whoami“-ähnlicher Call, oder ein Endpoint der den Token validiert und User liefert).

Wenn HA keine Userinfo liefert:

Mindestens: token validieren (z.B. GET /api/ o.ä.) und eine stabile ID serverseitig erzeugen und persistieren (z.B. Hash über Token-ID + issuer), aber nicht „substring“.

Speichere userId/userName nur aus einer verifizierten Quelle.

Akzeptanzkriterien

Keine Token-Substring IDs im Code.

User-ID ist stabil und eindeutig pro Benutzer.

Token wird gegen HA verifiziert.

3) Redirect/Base-URL absichern (HOCH)
Problem

Base URL wird aus Request-Headern (x-forwarded-host, cf-visitor, etc.) abgeleitet → Host Header Poisoning/Open Redirect möglich.

Umsetzung (Pflicht)

In Production nur APP_BASE_URL verwenden.

Wenn process.env.NODE_ENV === "production": deriveBaseUrlFromRequest() ignorieren.

Optional: Allowlist für Hosts, falls dynamisch nötig.

z.B. ALLOWED_HOSTS=dashboard.example.com

Reject/ignore wenn Host nicht in Allowlist.

Stelle sicher, dass Redirects nur zu APP_BASE_URL oder dessen Pfaden erfolgen.

Akzeptanzkriterien

In Prod kann kein fremder Host/Proto via Header die Redirect-URL beeinflussen.

Callback Redirect ist immer in der erlaubten Domain.

4) UniFi Controller URL validieren & SSRF-Fläche minimieren (HOCH)
Problem

Server ruft UniFi Controller URL aus DB auf → potentiell SSRF.

Umsetzung (Pflicht)

Validierung beim Speichern:

Nur https:// (oder explizit https:// + optional http:// in Dev).

Kein eingebetteter Credentials-Teil in URL (user:pass@host verbieten).

Optional: nur private Netze erlauben (RFC1918), wenn das Ziel immer lokal ist.

fetch() Aufrufe mit:

Timeout (AbortController)

Max Response Size (falls möglich)

Keine Secrets in Logs

Akzeptanzkriterien

Controller URL kann nicht auf verbotene Hosts/Protokolle gesetzt werden.

Requests haben Timeout.

5) Settings Input Validation + Größenlimits (MITTEL)
Problem

layoutConfig wird ohne Schema validiert gespeichert.

Umsetzung

Zod Schema für layoutConfig erstellen (Server-seitig).

Request Body Size Limit setzen.

Unknown Keys entweder:

strippen oder rejecten

Akzeptanzkriterien

Ungültiges layoutConfig wird mit 400 abgelehnt.

Keine unbounded JSON Speicherung.

6) Session Lifetime reduzieren (MITTEL)
Problem

365 Tage Session gültig.

Umsetzung

Reduziere auf z.B. 14–30 Tage.

Optional: Rolling sessions.

Für kritische Aktionen (Settings/Creds ändern) optional Re-Auth/CSRF-Check.

Akzeptanzkriterien

Cookie maxAge deutlich kleiner (<= 30 Tage).

Deliverables (Pflicht)

PR mit:

Code-Änderungen

Prisma Migration

Kurzer Changelog der Security-Fixes

Mini-Testplan (Text reicht):

Login HA funktioniert

Settings speichern/laden funktioniert

UniFi Events funktionieren

/api/settings liefert nie Passwörter

Hinweis, ob bestehende Installationen eine Datenmigration benötigen (und wie).