Web Push Notifications im HASS-Dashboard (user-spezifisch) + HA Trigger
Ziel

Das selbst programmierte Dashboard soll Browser Push Notifications senden können (Permission-Dialog im Browser).

User-spezifisch: Lukas und Simon separat (jede/r hat eigene Push-Subscription).

Home Assistant soll bei einer Automation per HTTP Call ans Dashboard Push an [lukas,simon] auslösen können.

Zusätzlich bleibt iMac-Popup in HA (browser_mod) separat – hier geht’s nur um die Dashboard-Pushes.

1) Voraussetzungen / Tech

Node/Next/Express Backend im Dashboard-Projekt (je nachdem was das Repo nutzt):

Wenn Next.js: API Routes (/pages/api/... oder /app/api/...)

Sonst: Express Server (/api/...)

NPM Package: web-push

Push benötigt VAPID Keys:

VAPID_PUBLIC_KEY

VAPID_PRIVATE_KEY

VAPID_SUBJECT (mailto oder URL)

ENV Variablen (Replit Secrets)

VAPID_PUBLIC_KEY

VAPID_PRIVATE_KEY

VAPID_SUBJECT

PUSH_API_SECRET (Shared Secret, das HA im Header mitsendet)

2) Frontend: Service Worker + Subscription UI
2.1 Service Worker Datei

Lege public/sw.js an (oder je nach Framework richtige Static-Location).

Inhalt:

self.addEventListener('push', ...) → Notification anzeigen

self.addEventListener('notificationclick', ...) → bei Klick URL öffnen/focus (z. B. /lovelace/home oder Dashboard route)

Payload-Format (vom Server):

{
  "title": "Es hat geklingelt!",
  "body": "An der Tür ist ...",
  "icon": "/icons/icon-192.png",
  "badge": "/icons/badge.png",
  "image": "https://.../klingel_event.jpg",
  "tag": "doorbell",
  "data": { "url": "/lovelace/home" }
}

2.2 Registrierung im Client

Beim App-Start (oder Settings-Seite):

navigator.serviceWorker.register('/sw.js')

2.3 Permission + Subscribe Flow

Implementiere Settings-Komponente “Benachrichtigungen”:

Auswahl/Zuordnung “Ich bin: Lukas / Simon” (Dropdown oder Buttons)

Button „Push aktivieren“

Notification.requestPermission()

registration.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: VAPID_PUBLIC_KEY })

POST Subscription ans Backend:

POST /api/push/subscribe

Body: { userId: "lukas"|"simon", subscription: PushSubscriptionJSON }

Wichtig: applicationServerKey ist die VAPID Public Key als Uint8Array (helper nötig).

2.4 Unsubscribe

Button „Push deaktivieren“

getSubscription() → unsubscribe()

optional POST /api/push/unsubscribe mit userId

3) Backend: Subscription speichern + Push senden
3.1 Datenspeicher (einfach & robust)

Für MVP: JSON Datei (z. B. data/push-subscriptions.json)

Struktur:

{
  "lukas": [ {subscription}, {subscription} ],
  "simon": [ {subscription} ]
}


Alternativ SQLite/Redis, aber Datei reicht.

3.2 Endpoint: Subscribe

POST /api/push/subscribe

nimmt { userId, subscription }

validiert userId ∈ {lukas, simon}

speichert Subscription dedupliziert (endpoint unique)

Rückgabe { ok: true }

3.3 Endpoint: Send (von HA aufgerufen)

POST /api/push/send

Security: Authorization: Bearer <PUSH_API_SECRET>

Body:

{
  "users": ["lukas","simon"],
  "title": "...",
  "message": "...",
  "image": "https://... oder /local/... (besser absolute URL)",
  "tag": "doorbell",
  "url": "/lovelace/home"
}


Für jeden user → alle gespeicherten subscriptions pushen.

3.4 web-push Versand

Setze VAPID:

webpush.setVapidDetails(VAPID_SUBJECT, VAPID_PUBLIC_KEY, VAPID_PRIVATE_KEY)

Sende Notification payload:

webpush.sendNotification(subscription, JSON.stringify(payload))

Fehlerbehandlung:

Wenn 410 Gone oder 404 → subscription aus DB entfernen

4) iOS / PWA Hinweis (für Abnahme)

iPhone Safari: Web Push geht zuverlässig nur, wenn:

die Seite als PWA „Zum Home-Bildschirm“ hinzugefügt wurde

iOS-Version unterstützt Push

Android/Chrome: meist direkt möglich.

Der UI-Text soll darauf hinweisen (kleiner Hinweis im Settings-Screen).

5) Optional: Testfunktion im Dashboard

Button „Test Push senden“

ruft backend POST /api/push/send intern auf (ohne HA), z. B. an eigenen User

erleichtert Debugging.

6) Home Assistant Integration (nur zur Vollständigkeit)

HA Automation ruft dein Dashboard an:

rest_command mit Authorization: Bearer PUSH_API_SECRET

sendet users: ["lukas","simon"], title, message, image, tag

(HA YAML hast du schon, kann separat eingebunden werden.)

Definition of Done

Im Browser erscheint Permission-Dialog, Subscription wird gespeichert.

POST /api/push/send schickt Push an Lukas/Simon spezifisch.

Klick auf Push öffnet Dashboard/URL.

Ungültige Subscriptions werden automatisch entfernt.